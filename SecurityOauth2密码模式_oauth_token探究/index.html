<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="SoftLeaderGy" href="https://softleadergy.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="SoftLeaderGy" href="https://softleadergy.github.io/atom.xml"><link rel="alternate" type="application/json" title="SoftLeaderGy" href="https://softleadergy.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="OAuth2、认证"><link rel="canonical" href="https://softleadergy.github.io/SecurityOauth2%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F_oauth_token%E6%8E%A2%E7%A9%B6/"><title>OAuth2 密码模式探究 | GuoYang = SoftLeaderGy = Gy Blog</title><meta name="generator" content="Hexo 6.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">OAuth2 密码模式探究</h1><div class="meta"><span class="item" title="创建时间：2023-06-19 21:01:49"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2023-06-19T21:01:49+08:00">2023-06-19</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>7.8k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>7 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">GuoYang</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><img src="/assets/oauth2_psd.jpeg"></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://softleadergy.github.io/SecurityOauth2%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F_oauth_token%E6%8E%A2%E7%A9%B6/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="GuoYang"><meta itemprop="description" content="Gy Blog, welcome to SoftLeaderGy Blog"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="SoftLeaderGy"></span><div class="body md" itemprop="articleBody"><h1 id="一-认证会用到的相关请求"><a class="anchor" href="#一-认证会用到的相关请求">#</a> 一、认证会用到的相关请求</h1><h2 id="11-获取access_token请求oauthtoken"><a class="anchor" href="#11-获取access_token请求oauthtoken">#</a> 1.1、获取 access_token 请求（/oauth/token）</h2><ul><li>请求所需参数：client_id、client_secret、grant_type、username、password</li></ul><figure class="highlight http"><figcaption data-lang="HTTP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token header"><span class="token header-name keyword">http</span><span class="token punctuation">:</span><span class="token header-value">//localhost/oauth/token?client_id=demoClientId&amp;client_secret=demoClientSecret&amp;grant_type=password&amp;username=demoUser&amp;password=50575tyL86xp29O380t1</span></span></pre></td></tr></table></figure><h2 id="12-检查头肯是否有效请求oauthcheck_token"><a class="anchor" href="#12-检查头肯是否有效请求oauthcheck_token">#</a> 1.2、检查头肯是否有效请求（/oauth/check_token）</h2><ul><li>请求所需参数：token</li></ul><figure class="highlight http"><figcaption data-lang="HTTP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token header"><span class="token header-name keyword">http</span><span class="token punctuation">:</span><span class="token header-value">//localhost/oauth/check_token?token=f57ce129-2d4d-4bd7-1111-f31ccc69d4d1</span></span></pre></td></tr></table></figure><h2 id="13-刷新token请求oauthtoken"><a class="anchor" href="#13-刷新token请求oauthtoken">#</a> 1.3、刷新 token 请求（/oauth/token）</h2><ul><li>请求所需参数：grant_type、refresh_token、client_id、client_secret 其中 grant_type 为固定值：grant_type=refresh_token</li></ul><figure class="highlight http"><figcaption data-lang="HTTP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token header"><span class="token header-name keyword">http</span><span class="token punctuation">:</span><span class="token header-value">//localhost/oauth/token?grant_type=refresh_token&amp;refresh_token=fbde81ee-f419-42b1-1234-9191f1f95be9&amp;client_id=demoClientId&amp;client_secret=demoClientSecret</span></span></pre></td></tr></table></figure><h1 id="二-工作原理"><a class="anchor" href="#二-工作原理">#</a> 二、工作原理</h1><h2 id="21-结构总结"><a class="anchor" href="#21-结构总结">#</a> 2.1、结构总结</h2><blockquote><p>Spring Security 所解决的问题就是安全访问控制，而安全访问控制功能其实就是对所有进入系统的请求进行拦截， 校验每个请求是否能够访问它所期望的资源。我们可以通过 Filter 或 AOP 等技术来实现，Spring Security 对 Web 资源的保护是靠 Filter 实现的，所以从这个 Filter 来入手，逐步深入 Spring Security 原理。<br>当初始化 Spring Security 时，会创建一个名为 SpringSecurityFilterChain 的 Servlet 过滤器，类型为 org.springframework.security.web.FilterChainProxy，它实现了 javax.servlet.Filter，因此外部的请求会经过此 类，下图是 Spring Security 过虑器链结构图：</p></blockquote><p><img data-src="../images/SecurityOauth2%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F_oauth_token%E6%8E%A2%E7%A9%B6_img/1668753467277-f793552d-3998-4d22-8e4e-3fe5941d94c5.png" alt="image.png"><br><img data-src="../images/SecurityOauth2%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F_oauth_token%E6%8E%A2%E7%A9%B6_img/1668753520154-ebfce956-2fa9-46a8-aef2-a974c386ebcf.png" alt="image.png"><br>FilterChainProxy 是一个代理，真正起作用的是 FilterChainProxy 中 SecurityFilterChain 所包含的各个 Filter，同时 这些 Filter 作为 Bean 被 Spring 管理，它们是 Spring Security 核心，各有各的职责，但他们并不直接处理用户的认 证，也不直接处理用户的授权，而是把它们交给了认证管理器（AuthenticationManager）和决策管理器 （AccessDecisionManager 进行处理，下图是 FilterChainProxy 相关类的 UML 图示。<br><img data-src="../images/SecurityOauth2%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F_oauth_token%E6%8E%A2%E7%A9%B6_img/1668754068624-1ac1d107-c0d4-40f0-b5d3-4dd55d58beeb.png" alt="image.png"><br>spring Security 功能的实现主要是由一系列过滤器链相互配合完成。<br><img data-src="../images/SecurityOauth2%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F_oauth_token%E6%8E%A2%E7%A9%B6_img/1668754156632-863aa0d9-a5bd-48b9-a1ca-ec7f2e76bf33.png" alt="image.png"><br>下面介绍过滤器链中主要的几个过滤器及其作用</p><ul><li>SecurityContextPersistenceFilter 这个 Filter 是整个拦截过程的入口和出口（也就是第一个和最后一个拦截 器），会在请求开始时从配置好的 SecurityContextRepository 中获取 SecurityContext，然后把它设置给 SecurityContextHolder。在请求完成后将 SecurityContextHolder 持有的 SecurityContext 再保存到配置好 的 SecurityContextRepository，同时清除 securityContextHolder 所持有的 SecurityContext；</li><li>UsernamePasswordAuthenticationFilter 用于处理来自表单提交的认证。该表单必须提供对应的用户名和密码，其内部还有登录成功或失败后进行处理的 AuthenticationSuccessHandler 和 AuthenticationFailureHandler，这些都可以根据需求做相关改变；</li><li>FilterSecurityInterceptor 是用于保护 web 资源的，使用 AccessDecisionManager 对当前用户进行授权访问，前面已经详细介绍过了；</li><li>ExceptionTranslationFilter 能够捕获来自 FilterChain 所有的异常，并进行处理。但是它只会处理两类异常： AuthenticationException 和 AccessDeniedException，其它的异常它会继续抛出。</li></ul><h2 id="22-认证流程"><a class="anchor" href="#22-认证流程">#</a> 2.2、认证流程</h2><p><img data-src="../images/SecurityOauth2%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F_oauth_token%E6%8E%A2%E7%A9%B6_img/1668754408721-6bef794a-d35c-45aa-87d7-495699d4f612.png" alt="image.png"><br>让我们仔细分析认证过程：</p><ol><li>用户提交用户名、密码被 SecurityFilterChain 中的 UsernamePasswordAuthenticationFilter 过滤器获取到， 封装为请求 Authentication，通常情况下是 UsernamePasswordAuthenticationToken 这个实现类。</li><li>然后过滤器将 Authentication 提交至认证管理器（AuthenticationManager）进行认证</li><li>认证成功后， AuthenticationManager 身份管理器返回一个被填充满了信息的（包括上面提到的权限信息， 身份信息，细节信息，但密码通常会被移除） Authentication 实例。</li><li>SecurityContextHolder 安全上下文容器将第 3 步填充了信息的 Authentication ，通过 SecurityContextHolder.getContext ().setAuthentication (…) 方法，设置到其中。 可以看出 AuthenticationManager 接口（认证管理器）是认证相关的核心接口，也是发起认证的出发点，它的实现类为 ProviderManager。而 Spring Security 支持多种认证方式，因此 ProviderManager 维护着一个 List 列表，存放多种认证方式，最终实际的认证工作是由 AuthenticationProvider 完成的。咱们知道 web 表单的对应的 AuthenticationProvider 实现类为 DaoAuthenticationProvider，它的内部又维护着一个 UserDetailsService 负责 UserDetails 的获取。最终 AuthenticationProvider 将 UserDetails 填充至 Authentication。 认证核心组件的大体关系如下：</li></ol><p><img data-src="../images/SecurityOauth2%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F_oauth_token%E6%8E%A2%E7%A9%B6_img/1668758671512-f9051627-947f-495c-9af3-986cb0e7d364.png" alt="image.png"></p><h3 id="authenticationprovider"><a class="anchor" href="#authenticationprovider">#</a> AuthenticationProvider</h3><p>通过前面的 Spring Security 认证流程我们得知，认证管理器（AuthenticationManager）委托 AuthenticationProvider 完成认证工作。 AuthenticationProvider 是一个接口，定义如下</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AuthenticationProvider</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token class-name">Authentication</span> <span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> var1<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">boolean</span> <span class="token function">supports</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> var1<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ul><li>authenticate () 方法定义了认证的实现过程，它的参数是一个 Authentication，里面包含了登录用户所提交的用户名、密码等。而返回值也是一个 Authentication，这个 Authentication 则是在认证成功后，将用户的权限及其他信 息重新组装后生成。</li><li>Spring Security 中维护着一个 List 列表，存放多种认证方式，不同的认证方式使用不同的 AuthenticationProvider。如使用用户名密码登录时，使用 AuthenticationProvider1，短信登录时使用 AuthenticationProvider2 等等这样的例子很多。</li><li>每个 AuthenticationProvider 需要实现 supports（）方法来表明自己支持的认证方式，如我们使用表单方式认证， 在提交请求时 Spring Security 会生成 UsernamePasswordAuthenticationToken，它是一个 Authentication，里面 封装着用户提交的用户名、密码信息。而对应的，哪个 AuthenticationProvider 来处理它？</li></ul><p>我们在 DaoAuthenticationProvider 的基类 AbstractUserDetailsAuthenticationProvider 发现以下代码：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">supports</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> authentication<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>也就是说当 web 表单提交用户名密码时，Spring Security 由 DaoAuthenticationProvider 处理。<br>最后，我们来看一下 Authentication (认证信息) 的结构，它是一个接口，我们之前提到的 UsernamePasswordAuthenticationToken 就是它的实现之一：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Authentication</span> <span class="token keyword">extends</span> <span class="token class-name">Principal</span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">></span></span> <span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token class-name">Object</span> <span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token class-name">Object</span> <span class="token function">getDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token class-name">Object</span> <span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">boolean</span> <span class="token function">isAuthenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">void</span> <span class="token function">setAuthenticated</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> var1<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="../images/SecurityOauth2%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F_oauth_token%E6%8E%A2%E7%A9%B6_img/1668759557994-6e33ecb3-c086-4e53-8c99-34b173ff7d8d.png" alt="image.png"></p><ol><li>Authentication 是 spring security 包中的接口，直接继承自 Principal 类，而 Principal 是位于 java.security 包中的。它是表示着一个抽象主体身份，任何主体都有一个名称，因此包含一个 getName () 方法。</li><li>getAuthorities ()，权限信息列表，默认是 GrantedAuthority 接口的一些实现类，通常是代表权限信息的一系 列字符串。</li><li>getCredentials ()，凭证信息，用户输入的密码字符串，在认证过后通常会被移除，用于保障安全。</li><li>getDetails ()，细节信息，web 应用中的实现接口通常为 WebAuthenticationDetails，它记录了访问者的 ip 地 址和 sessionId 的值。</li><li>getPrincipal ()，身份信息，大部分情况下返回的是 UserDetails 接口的实现类，UserDetails 代表用户的详细 信息，那从 Authentication 中取出来的 UserDetails 就是当前登录用户信息，它也是框架中的常用接口之一。</li></ol><h3 id="userdetailsservice"><a class="anchor" href="#userdetailsservice">#</a> UserDetailsService</h3><p>现在咱们现在知道 DaoAuthenticationProvider 处理了 web 表单的认证逻辑，认证成功后既得到一个 Authentication (UsernamePasswordAuthenticationToken 实现)，里面包含了身份信息（Principal）。这个身份 信息就是一个 Object ，大多数情况下它可以被强转为 UserDetails 对象。</p><p>DaoAuthenticationProvider 中包含了一个 UserDetailsService 实例，它负责根据用户名提取用户信息 UserDetails (包含密码)，而后 DaoAuthenticationProvider 会去对比 UserDetailsService 提取的用户密码与用户提交 的密码是否匹配作为认证成功的关键依据，因此可以通过将自定义的 UserDetailsService 公开为 spring bean 来定义自定义身份验证</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> var1<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>很多人把 DaoAuthenticationProvider 和 UserDetailsService 的职责搞混淆，其实 UserDetailsService 只负责从特定 的地方（通常是数据库）加载用户信息，仅此而已。而 DaoAuthenticationProvider 的职责更大，它完成完整的认证流程，同时会把 UserDetails 填充至 Authentication。</p><h3 id="userdetails"><a class="anchor" href="#userdetails">#</a> UserDetails</h3><p>上面一直提到 UserDetails 是用户信息，咱们看一下它的真面目：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserDetails</span> <span class="token keyword">extends</span> <span class="token class-name">Serializable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">></span></span> <span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token class-name">String</span> <span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token class-name">String</span> <span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">boolean</span> <span class="token function">isAccountNonExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">boolean</span> <span class="token function">isAccountNonLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">boolean</span> <span class="token function">isCredentialsNonExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">boolean</span> <span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>它和 Authentication 接口很类似，比如它们都拥有 username，authorities。Authentication 的 getCredentials () 与 UserDetails 中的 getPassword () 需要被区分对待，前者是用户提交的密码凭证，后者是用户实际存储的密码，认证 其实就是对这两者的比对。Authentication 中的 getAuthorities () 实际是由 UserDetails 的 getAuthorities () 传递而形成的。还记得 Authentication 接口中的 getDetails () 方法吗？其中的 UserDetails 用户详细信息便是经过了 AuthenticationProvider 认证之后被填充的。<br>通过实现 UserDetailsService 和 UserDetails，我们可以完成对用户信息获取方式以及用户信息字段的扩展。<br>Spring Security 提供的 InMemoryUserDetailsManager (内存认证)，JdbcUserDetailsManager (jdbc 认证) 就是 UserDetailsService 的实现类，主要区别无非就是从内存还是从数据库加载用户</p><h2 id="23-获取token的主要流程"><a class="anchor" href="#23-获取token的主要流程">#</a> 2.3、获取 token 的主要流程</h2><ol><li>用户发起获取 token 的请求。</li><li>过滤器会验证 path 是否是认证的请求 /oauth/token，如果为 false，则直接返回没有后续操作。</li><li>过滤器通过 clientId 查询生成一个 Authentication 对象。</li><li>然后会通过 username 和生成的 Authentication 对象生成一个 UserDetails 对象，并检查用户是否存在。</li><li>以上全部通过会进入地址 /oauth/token，即 TokenEndpoint 的 postAccessToken 方法中。</li><li>postAccessToken 方法中会验证 Scope，然后验证是否是 refreshToken 请求等。</li><li>之后调用 AbstractTokenGranter 中的 grant 方法。</li><li>grant 方法中调用 AbstractUserDetailsAuthenticationProvider 的 authenticate 方法，通过 username 和 Authentication 对象来检索用户是否存在。</li><li>然后通过 DefaultTokenServices 类从 tokenStore 中获取 OAuth2AccessToken 对象。</li><li>然后将 OAuth2AccessToken 对象包装进响应流返回。</li></ol><h3 id="231-代码执行流程"><a class="anchor" href="#231-代码执行流程">#</a> 2.3.1、代码执行流程：</h3><blockquote><p>TokenEndpoint.postAccessToken () ---&gt; AbstractTokenGranter.grant () ---&gt; AbstractUserDetailsAuthenticationProvider.authenticate () ---&gt; DefaultTokenServices 类从 tokenStore 中获取 OAuth2AccessToken 对象 ---&gt; OAuth2AccessToken 对象包装进响应流返回</p></blockquote><h3 id="232-代码截图执行流程"><a class="anchor" href="#232-代码截图执行流程">#</a> 2.3.2、代码截图执行流程</h3><h4 id="解析-客户端凭证值的格式为basic空格-client_idclient_secret经过base64加密后的值"><a class="anchor" href="#解析-客户端凭证值的格式为basic空格-client_idclient_secret经过base64加密后的值">#</a> 解析 客户端凭证，值的格式为 Basic 空格 + client_id:client_secret 经过 Base64 加密后的值</h4><p><img data-src="../images/SecurityOauth2%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F_oauth_token%E6%8E%A2%E7%A9%B6_img/1668761342232-ad1dc737-093e-4475-a81f-88e8fb491b4e.png" alt="image.png"><br><img data-src="../images/SecurityOauth2%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F_oauth_token%E6%8E%A2%E7%A9%B6_img/1668761695470-392407be-0448-452c-a464-11eb2546040f.png" alt="image.png"></p><h4 id="1一个比较重要的过滤器"><a class="anchor" href="#1一个比较重要的过滤器">#</a> ①一个比较重要的过滤器</h4><p><img data-src="../images/SecurityOauth2%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F_oauth_token%E6%8E%A2%E7%A9%B6_img/1668762169094-a93bf6b6-fdc0-4f50-80d8-5f055d282f0f.png" alt="image.png"></p><h4 id="2此处是1中的attemptauthentication方法"><a class="anchor" href="#2此处是1中的attemptauthentication方法">#</a> ②此处是①中的 attemptAuthentication 方法</h4><p><img data-src="../images/SecurityOauth2%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F_oauth_token%E6%8E%A2%E7%A9%B6_img/1668762462925-c53ccc77-b78e-49a7-badb-56541de14059.png" alt="image.png"></p><h4 id="3此处是2中调用的authenticate方法"><a class="anchor" href="#3此处是2中调用的authenticate方法">#</a> ③此处是②中调用的 authenticate 方法</h4><p><img data-src="../images/SecurityOauth2%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F_oauth_token%E6%8E%A2%E7%A9%B6_img/1668762798314-a6639f98-3a2b-4e71-b55d-a893672e835d.png" alt="image.png"><br><img data-src="../images/SecurityOauth2%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F_oauth_token%E6%8E%A2%E7%A9%B6_img/1668763023424-ccd05193-0570-4917-8f87-a395359f4a9c.png" alt="image.png"></p><h4 id="4-此处是3中调用的abstractuserdetailsauthenticationprovider类的authenticate方法"><a class="anchor" href="#4-此处是3中调用的abstractuserdetailsauthenticationprovider类的authenticate方法">#</a> ④ 此处是③中调用的 AbstractUserDetailsAuthenticationProvider 类的 authenticate 方法</h4><p><img data-src="../images/SecurityOauth2%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F_oauth_token%E6%8E%A2%E7%A9%B6_img/1668763206292-f4dcd5f2-e54c-413e-a3ba-8fe0bd3fc9d8.png" alt="image.png"></p><h4 id="5-此处是4中调用的daoauthenticationprovider类的retrieveuser方法"><a class="anchor" href="#5-此处是4中调用的daoauthenticationprovider类的retrieveuser方法">#</a> ⑤ 此处是④中调用的 DaoAuthenticationProvider 类的 retrieveUser 方法</h4><p><img data-src="../images/SecurityOauth2%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F_oauth_token%E6%8E%A2%E7%A9%B6_img/1668763841953-4c10e52d-2b97-411e-919f-0f3cb5761447.png" alt="image.png"></p><h4 id="6此处为5中调用的clientdetailsuserdetailsservice类的loaduserbyusername方法执行完后接着返回执行4之后的方法"><a class="anchor" href="#6此处为5中调用的clientdetailsuserdetailsservice类的loaduserbyusername方法执行完后接着返回执行4之后的方法">#</a> ⑥此处为⑤中调用的 ClientDetailsUserDetailsService 类的 loadUserByUsername 方法，执行完后接着返回执行④之后的方法</h4><p><img data-src="../images/SecurityOauth2%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F_oauth_token%E6%8E%A2%E7%A9%B6_img/1668763995970-26681491-a9eb-4ca3-8874-293d5a1e3a82.png" alt="image.png"></p><h4 id="7此处为4中调用的daoauthenticationprovider类的additionalauthenticationchecks方法此处执行完则主要过滤器执行完毕后续会进入oauthtoken映射的方法"><a class="anchor" href="#7此处为4中调用的daoauthenticationprovider类的additionalauthenticationchecks方法此处执行完则主要过滤器执行完毕后续会进入oauthtoken映射的方法">#</a> ⑦此处为④中调用的 DaoAuthenticationProvider 类的 additionalAuthenticationChecks 方法，此处执行完则主要过滤器执行完毕，后续会进入 /oauth/token 映射的方法。</h4><p><img data-src="../images/SecurityOauth2%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F_oauth_token%E6%8E%A2%E7%A9%B6_img/1668764674222-75cb23a4-47a5-45ec-8d9a-e3c628a27ec2.png" alt="image.png"></p><h4 id="8此处进入oauthtoken映射的tokenendpoint类的postaccesstoken方法"><a class="anchor" href="#8此处进入oauthtoken映射的tokenendpoint类的postaccesstoken方法">#</a> ⑧此处进入 /oauth/token 映射的 TokenEndpoint 类的 postAccessToken 方法</h4><p><img data-src="../images/SecurityOauth2%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F_oauth_token%E6%8E%A2%E7%A9%B6_img/1668764793917-57af320d-0dcc-4fee-bcd7-adb52d3abcf7.png" alt="image.png"><br>postAccessToken 方法<br><img data-src="../images/SecurityOauth2%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F_oauth_token%E6%8E%A2%E7%A9%B6_img/1668766406035-797c2c03-9e07-419d-8a0d-1bf1d00b4bca.png" alt="image.png"></p><h4 id="9此处为8中调用的abstracttokengranter类的grant方法"><a class="anchor" href="#9此处为8中调用的abstracttokengranter类的grant方法">#</a> ⑨此处为⑧中调用的 AbstractTokenGranter 类的 grant 方法</h4><p><img data-src="../images/SecurityOauth2%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F_oauth_token%E6%8E%A2%E7%A9%B6_img/1668766466494-5d387673-f8b1-449c-9303-d762d8689c50.png" alt="image.png"></p><h4 id="10此处为9中调用的resourceownerpasswordtokengranter类中的getoauth2authentication方法"><a class="anchor" href="#10此处为9中调用的resourceownerpasswordtokengranter类中的getoauth2authentication方法">#</a> ⑩此处为⑨中调用的 ResourceOwnerPasswordTokenGranter 类中的 getOAuth2Authentication 方法</h4><p><img data-src="../images/SecurityOauth2%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F_oauth_token%E6%8E%A2%E7%A9%B6_img/1668766606138-adff4a7e-c6a2-4ed8-b21f-364bfd057dae.png" alt="image.png"><br><img data-src="../images/SecurityOauth2%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F_oauth_token%E6%8E%A2%E7%A9%B6_img/1668766716340-85ba3598-f28d-400f-91ed-f29850ccdcc7.png" alt="image.png"><br><img data-src="../images/SecurityOauth2%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F_oauth_token%E6%8E%A2%E7%A9%B6_img/1668766954447-1e9bc70b-e749-4393-920c-f299e059442d.png" alt="image.png"></p><h4 id="101-此处为10中调用的自定义的customuserauthenticationprovider类中的authenticate方法此处校验用户密码是否正确此处执行完则返回9执行后续方法"><a class="anchor" href="#101-此处为10中调用的自定义的customuserauthenticationprovider类中的authenticate方法此处校验用户密码是否正确此处执行完则返回9执行后续方法">#</a> ⑩① 此处为⑩中调用的自定义的 CustomUserAuthenticationProvider 类中的 authenticate 方法，此处校验用户密码是否正确，此处执行完则返回⑨执行后续方法。</h4><p><img data-src="../images/SecurityOauth2%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F_oauth_token%E6%8E%A2%E7%A9%B6_img/1668767145161-44995f9d-7a02-4d8c-a601-2bdf7b2f249c.png" alt="image.png"></p><h4 id="102-此处为9中调用的defaulttokenservices中的createaccesstoken方法"><a class="anchor" href="#102-此处为9中调用的defaulttokenservices中的createaccesstoken方法">#</a> ⑩② 此处为⑨中调用的 DefaultTokenServices 中的 createAccessToken 方法</h4><p><img data-src="../images/SecurityOauth2%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F_oauth_token%E6%8E%A2%E7%A9%B6_img/1668767530308-3ed24074-1b4c-4cb5-98c8-2232080e9f94.png" alt="image.png"><br><img data-src="../images/SecurityOauth2%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F_oauth_token%E6%8E%A2%E7%A9%B6_img/1668767715846-e05a5345-6a8c-4a54-9330-cce566d76775.png" alt="image.png"></p><h4 id="103此处为12中调用的redistokenstore中的getaccesstoken方法等此处执行完则一直向上返回到8中执行后续方法"><a class="anchor" href="#103此处为12中调用的redistokenstore中的getaccesstoken方法等此处执行完则一直向上返回到8中执行后续方法">#</a> ⑩③此处为 12 中调用的 RedisTokenStore 中的 getAccessToken 方法等，此处执行完，则一直向上返回到⑧中执行后续方法。</h4><p><img data-src="../images/SecurityOauth2%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F_oauth_token%E6%8E%A2%E7%A9%B6_img/1668767478392-0f5160f0-6de7-43fe-bb4a-12596cbd7c07.png" alt="image.png"></p><h4 id="104此处为8中获取到token后需要包装返回流操作"><a class="anchor" href="#104此处为8中获取到token后需要包装返回流操作">#</a> ⑩④此处为⑧中获取到 token 后需要包装返回流操作</h4><p><img data-src="../images/SecurityOauth2%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F_oauth_token%E6%8E%A2%E7%A9%B6_img/1668767818536-a816c39b-8da8-4d4c-9f0f-78c318621371.png" alt="image.png"></p><div class="tags"><a href="/tags/OAuth2%E3%80%81%E8%AE%A4%E8%AF%81/" rel="tag"><i class="ic i-tag"></i> OAuth2、认证</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2023-06-19 21:22:42" itemprop="dateModified" datetime="2023-06-19T21:22:42+08:00">2023-06-19</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="GuoYang 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.png" alt="GuoYang 支付宝"><p>支付宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>GuoYang <i class="ic i-at"><em>@</em></i>SoftLeaderGy</li><li class="link"><strong>本文链接：</strong> <a href="https://softleadergy.github.io/SecurityOauth2%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F_oauth_token%E6%8E%A2%E7%A9%B6/" title="OAuth2 密码模式探究">https://softleadergy.github.io/SecurityOauth2密码模式_oauth_token探究/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/CPU%E9%A3%99%E5%8D%87%E6%8E%92%E6%9F%A5/" itemprop="url" rel="prev" data-background-image="&#x2F;assets&#x2F;WechatIMG27.jpeg" title="CPU飙升排查"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i></span><h3>CPU飙升排查</h3></a></div><div class="item right"></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80-%E8%AE%A4%E8%AF%81%E4%BC%9A%E7%94%A8%E5%88%B0%E7%9A%84%E7%9B%B8%E5%85%B3%E8%AF%B7%E6%B1%82"><span class="toc-number">1.</span> <span class="toc-text">一、认证会用到的相关请求</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#11-%E8%8E%B7%E5%8F%96access_token%E8%AF%B7%E6%B1%82oauthtoken"><span class="toc-number">1.1.</span> <span class="toc-text">1.1、获取 access_token 请求（&#x2F;oauth&#x2F;token）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-%E6%A3%80%E6%9F%A5%E5%A4%B4%E8%82%AF%E6%98%AF%E5%90%A6%E6%9C%89%E6%95%88%E8%AF%B7%E6%B1%82oauthcheck_token"><span class="toc-number">1.2.</span> <span class="toc-text">1.2、检查头肯是否有效请求（&#x2F;oauth&#x2F;check_token）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-%E5%88%B7%E6%96%B0token%E8%AF%B7%E6%B1%82oauthtoken"><span class="toc-number">1.3.</span> <span class="toc-text">1.3、刷新 token 请求（&#x2F;oauth&#x2F;token）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">2.</span> <span class="toc-text">二、工作原理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#21-%E7%BB%93%E6%9E%84%E6%80%BB%E7%BB%93"><span class="toc-number">2.1.</span> <span class="toc-text">2.1、结构总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#22-%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B"><span class="toc-number">2.2.</span> <span class="toc-text">2.2、认证流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#authenticationprovider"><span class="toc-number">2.2.1.</span> <span class="toc-text">AuthenticationProvider</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#userdetailsservice"><span class="toc-number">2.2.2.</span> <span class="toc-text">UserDetailsService</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#userdetails"><span class="toc-number">2.2.3.</span> <span class="toc-text">UserDetails</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#23-%E8%8E%B7%E5%8F%96token%E7%9A%84%E4%B8%BB%E8%A6%81%E6%B5%81%E7%A8%8B"><span class="toc-number">2.3.</span> <span class="toc-text">2.3、获取 token 的主要流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#231-%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-number">2.3.1.</span> <span class="toc-text">2.3.1、代码执行流程：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#232-%E4%BB%A3%E7%A0%81%E6%88%AA%E5%9B%BE%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-number">2.3.2.</span> <span class="toc-text">2.3.2、代码截图执行流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90-%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%87%AD%E8%AF%81%E5%80%BC%E7%9A%84%E6%A0%BC%E5%BC%8F%E4%B8%BAbasic%E7%A9%BA%E6%A0%BC-client_idclient_secret%E7%BB%8F%E8%BF%87base64%E5%8A%A0%E5%AF%86%E5%90%8E%E7%9A%84%E5%80%BC"><span class="toc-number">2.3.2.1.</span> <span class="toc-text">解析 客户端凭证，值的格式为 Basic 空格 + client_id:client_secret 经过 Base64 加密后的值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E4%B8%80%E4%B8%AA%E6%AF%94%E8%BE%83%E9%87%8D%E8%A6%81%E7%9A%84%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">2.3.2.2.</span> <span class="toc-text">①一个比较重要的过滤器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E6%AD%A4%E5%A4%84%E6%98%AF1%E4%B8%AD%E7%9A%84attemptauthentication%E6%96%B9%E6%B3%95"><span class="toc-number">2.3.2.3.</span> <span class="toc-text">②此处是①中的 attemptAuthentication 方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E6%AD%A4%E5%A4%84%E6%98%AF2%E4%B8%AD%E8%B0%83%E7%94%A8%E7%9A%84authenticate%E6%96%B9%E6%B3%95"><span class="toc-number">2.3.2.4.</span> <span class="toc-text">③此处是②中调用的 authenticate 方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E6%AD%A4%E5%A4%84%E6%98%AF3%E4%B8%AD%E8%B0%83%E7%94%A8%E7%9A%84abstractuserdetailsauthenticationprovider%E7%B1%BB%E7%9A%84authenticate%E6%96%B9%E6%B3%95"><span class="toc-number">2.3.2.5.</span> <span class="toc-text">④ 此处是③中调用的 AbstractUserDetailsAuthenticationProvider 类的 authenticate 方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E6%AD%A4%E5%A4%84%E6%98%AF4%E4%B8%AD%E8%B0%83%E7%94%A8%E7%9A%84daoauthenticationprovider%E7%B1%BB%E7%9A%84retrieveuser%E6%96%B9%E6%B3%95"><span class="toc-number">2.3.2.6.</span> <span class="toc-text">⑤ 此处是④中调用的 DaoAuthenticationProvider 类的 retrieveUser 方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6%E6%AD%A4%E5%A4%84%E4%B8%BA5%E4%B8%AD%E8%B0%83%E7%94%A8%E7%9A%84clientdetailsuserdetailsservice%E7%B1%BB%E7%9A%84loaduserbyusername%E6%96%B9%E6%B3%95%E6%89%A7%E8%A1%8C%E5%AE%8C%E5%90%8E%E6%8E%A5%E7%9D%80%E8%BF%94%E5%9B%9E%E6%89%A7%E8%A1%8C4%E4%B9%8B%E5%90%8E%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">2.3.2.7.</span> <span class="toc-text">⑥此处为⑤中调用的 ClientDetailsUserDetailsService 类的 loadUserByUsername 方法，执行完后接着返回执行④之后的方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7%E6%AD%A4%E5%A4%84%E4%B8%BA4%E4%B8%AD%E8%B0%83%E7%94%A8%E7%9A%84daoauthenticationprovider%E7%B1%BB%E7%9A%84additionalauthenticationchecks%E6%96%B9%E6%B3%95%E6%AD%A4%E5%A4%84%E6%89%A7%E8%A1%8C%E5%AE%8C%E5%88%99%E4%B8%BB%E8%A6%81%E8%BF%87%E6%BB%A4%E5%99%A8%E6%89%A7%E8%A1%8C%E5%AE%8C%E6%AF%95%E5%90%8E%E7%BB%AD%E4%BC%9A%E8%BF%9B%E5%85%A5oauthtoken%E6%98%A0%E5%B0%84%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">2.3.2.8.</span> <span class="toc-text">⑦此处为④中调用的 DaoAuthenticationProvider 类的 additionalAuthenticationChecks 方法，此处执行完则主要过滤器执行完毕，后续会进入 &#x2F;oauth&#x2F;token 映射的方法。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8%E6%AD%A4%E5%A4%84%E8%BF%9B%E5%85%A5oauthtoken%E6%98%A0%E5%B0%84%E7%9A%84tokenendpoint%E7%B1%BB%E7%9A%84postaccesstoken%E6%96%B9%E6%B3%95"><span class="toc-number">2.3.2.9.</span> <span class="toc-text">⑧此处进入 &#x2F;oauth&#x2F;token 映射的 TokenEndpoint 类的 postAccessToken 方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9%E6%AD%A4%E5%A4%84%E4%B8%BA8%E4%B8%AD%E8%B0%83%E7%94%A8%E7%9A%84abstracttokengranter%E7%B1%BB%E7%9A%84grant%E6%96%B9%E6%B3%95"><span class="toc-number">2.3.2.10.</span> <span class="toc-text">⑨此处为⑧中调用的 AbstractTokenGranter 类的 grant 方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10%E6%AD%A4%E5%A4%84%E4%B8%BA9%E4%B8%AD%E8%B0%83%E7%94%A8%E7%9A%84resourceownerpasswordtokengranter%E7%B1%BB%E4%B8%AD%E7%9A%84getoauth2authentication%E6%96%B9%E6%B3%95"><span class="toc-number">2.3.2.11.</span> <span class="toc-text">⑩此处为⑨中调用的 ResourceOwnerPasswordTokenGranter 类中的 getOAuth2Authentication 方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#101-%E6%AD%A4%E5%A4%84%E4%B8%BA10%E4%B8%AD%E8%B0%83%E7%94%A8%E7%9A%84%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84customuserauthenticationprovider%E7%B1%BB%E4%B8%AD%E7%9A%84authenticate%E6%96%B9%E6%B3%95%E6%AD%A4%E5%A4%84%E6%A0%A1%E9%AA%8C%E7%94%A8%E6%88%B7%E5%AF%86%E7%A0%81%E6%98%AF%E5%90%A6%E6%AD%A3%E7%A1%AE%E6%AD%A4%E5%A4%84%E6%89%A7%E8%A1%8C%E5%AE%8C%E5%88%99%E8%BF%94%E5%9B%9E9%E6%89%A7%E8%A1%8C%E5%90%8E%E7%BB%AD%E6%96%B9%E6%B3%95"><span class="toc-number">2.3.2.12.</span> <span class="toc-text">⑩① 此处为⑩中调用的自定义的 CustomUserAuthenticationProvider 类中的 authenticate 方法，此处校验用户密码是否正确，此处执行完则返回⑨执行后续方法。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#102-%E6%AD%A4%E5%A4%84%E4%B8%BA9%E4%B8%AD%E8%B0%83%E7%94%A8%E7%9A%84defaulttokenservices%E4%B8%AD%E7%9A%84createaccesstoken%E6%96%B9%E6%B3%95"><span class="toc-number">2.3.2.13.</span> <span class="toc-text">⑩② 此处为⑨中调用的 DefaultTokenServices 中的 createAccessToken 方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#103%E6%AD%A4%E5%A4%84%E4%B8%BA12%E4%B8%AD%E8%B0%83%E7%94%A8%E7%9A%84redistokenstore%E4%B8%AD%E7%9A%84getaccesstoken%E6%96%B9%E6%B3%95%E7%AD%89%E6%AD%A4%E5%A4%84%E6%89%A7%E8%A1%8C%E5%AE%8C%E5%88%99%E4%B8%80%E7%9B%B4%E5%90%91%E4%B8%8A%E8%BF%94%E5%9B%9E%E5%88%B08%E4%B8%AD%E6%89%A7%E8%A1%8C%E5%90%8E%E7%BB%AD%E6%96%B9%E6%B3%95"><span class="toc-number">2.3.2.14.</span> <span class="toc-text">⑩③此处为 12 中调用的 RedisTokenStore 中的 getAccessToken 方法等，此处执行完，则一直向上返回到⑧中执行后续方法。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#104%E6%AD%A4%E5%A4%84%E4%B8%BA8%E4%B8%AD%E8%8E%B7%E5%8F%96%E5%88%B0token%E5%90%8E%E9%9C%80%E8%A6%81%E5%8C%85%E8%A3%85%E8%BF%94%E5%9B%9E%E6%B5%81%E6%93%8D%E4%BD%9C"><span class="toc-number">2.3.2.15.</span> <span class="toc-text">⑩④此处为⑧中获取到 token 后需要包装返回流操作</span></a></li></ol></li></ol></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="GuoYang" data-src="/images/avatar.jpg"><p class="name" itemprop="name">GuoYang</p><div class="description" itemprop="description">welcome to SoftLeaderGy Blog</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">3</span> <span class="name">文章</span></a></div><div class="item tags"><a href="/tags/"><span class="count">3</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL1NvZnRMZWFkZXJHeQ==" title="https:&#x2F;&#x2F;github.com&#x2F;SoftLeaderGy"><i class="ic i-github"></i></span> <span class="exturl item zhihu" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS95YW5nLXlhbmcteWFuZy01My01Mi02Nw==" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;yang-yang-yang-53-52-67"><i class="ic i-zhihu"></i></span> <span class="exturl item share" data-url="aHR0cHM6Ly9zZWdtZW50ZmF1bHQuY29tL3UveWFuZ3lhbmd5YW5nXzYyMTQ4YjBkMGI5Y2U=" title="https:&#x2F;&#x2F;segmentfault.com&#x2F;u&#x2F;yangyangyang_62148b0d0b9ce"><i class="ic i-share"></i></span> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTQxMzE0NTI5MA==" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;413145290"><i class="ic i-cloud-music"></i></span> <span class="exturl item weibo" data-url="aHR0cHM6Ly93ZWliby5jb20vdS82MjQ2OTk5MzA3" title="https:&#x2F;&#x2F;weibo.com&#x2F;u&#x2F;6246999307"><i class="ic i-weibo"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>友達</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"></div><span><a href="/SecurityOauth2%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F_oauth_token%E6%8E%A2%E7%A9%B6/" title="OAuth2密码模式探究">OAuth2密码模式探究</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/CPU%E9%A3%99%E5%8D%87%E6%8E%92%E6%9F%A5/" title="CPU飙升排查">CPU飙升排查</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/xxl-job%E6%90%AD%E5%BB%BA/" title="xxl-job搭建">xxl-job搭建</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2023</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">GuoYang @ GuoYang</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">18k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">16 分钟</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"SecurityOauth2密码模式_oauth_token探究/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html>